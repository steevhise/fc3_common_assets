{#
  TODO: Post New
  - example /home/new_post/
  - make Offer Buttons Selectable, it doesn't need to be disabled since we are able to select an offer at this state.
  - update actions route to post save, do this after visual tests are complete.
  - confirm if we need to check userId ?
#}

{% extends '../layout/layout.html' %}

{#
  NOTE: we model an empty post here to get the reactivity in our form.
#}
{% set post = {
  group: {
    group_name: ""
  },
  group_id: "",
  postType: {
    post_type_name: ""
  },
  post_description: "",
  post_id: "",
  post_location: "",
  post_subject: ""
} %}

{% block content %}
  {% parent %}
    {# We programmatically add errors here via the image uploader component #}
    <div class="form-errors-container"></div>
    <div class="new_post row">
        <div class="row">
            <h2 class="post-header-title text-center columns large-12">{{ title }}</h2>
        </div>
        <hr class="section-divider" />
        <div class="row">
            <form method="POST" class="columns large-10 large-offset-1" id="post_edit" ref="post_edit_form" enctype="multipart/form-data">
                <input type="hidden" name="crumb" value="{{crumb}}"/>
                <div class="form-group">
                    <label>Select type of Post</label>
                    <div class="button-bar" data-post-buttongroup>
                        {% include "../partials/post_types.html" with {
                            name: 'type',
                            value: data.post.type || 1,
                            postTypes: [
                              { name: 'Offer', value: 1 },
                              { name: 'Wanted', value: 3 },
                              { name: 'Lend', value: 9 },
                              { name: 'Borrow', value: 10 }
                            ]
                          } only
                        %}
                    </div>
                </div>
                <div class="form-group">
                    <label>Post title</label>
                    <input name="subject" value="{{data.post.subject}}" type="text" required />
                </div>
                <div class="form-group">
                    <label>Upload Pictures</label>
                    <p>Up to 3 images. Only jpg/jpegs and pngs. Images can be at most 1MB.</p>
                    <div class="upload-errors-container"></div>
                    <div class="dropbox">
                      <input name="images" type="file" id="images" multiple accept="image/jpeg,image/png" class="input-file" />
                      <p class="enabled-upload">Drag your files here to begin upload</p>
                      <p class="disabled-upload" hidden>You've uploaded the max allowed images</p>
                    </div>
                    <div class="selected-files row"></div>
                    <script>
                        document.addEventListener("DOMContentLoaded", init, false);

                        function init() {
                            document.querySelector('#images').addEventListener('change', handleFileInput);
                            window.ImageUploader = {};
                            // TODO Needs to be initialized w/ files retrieved from server
                            ImageUploader.filesList = [];
                            ImageUploader.displayError = function (msg, container) {
                              var errEl = document.createElement("p");
                              var errMsg = document.createTextNode(msg);
                              errEl.setAttribute("class", "callout alert");
                              errEl.appendChild(errMsg);
                              container.appendChild(errEl);
                            };
                            ImageUploader.displayImage = function () {
                                // Display image block w/ delete button
                                // Register click listener on delete button
                            };

                            document.querySelector("#post_edit").addEventListener("submit", function(e) {
                              e.preventDefault();
                              var formElement = document.querySelector("form");
                              var body = new FormData(formElement);
                              var errorContainer = document.querySelector(".form-errors-container");

                              // Reset the form validation errors
                              while (errorContainer.firstChild) {
                                errorContainer.removeChild(errorContainer.firstChild)
                              }

                              ImageUploader.filesList.forEach((file, index) => {
                                  // Prevent duplicate submission of last-uploaded image
                                  if (index === 0) {
                                    return body.set('images', file, file.name);
                                  }

                                  return body.append('images', file, file.name);
                              });

                              // This accesses the value of the CKEDITOR Vue component, which isn't set on the FormData object
                              // editor-0 is the default editor name (as configured in fc3_common_assets Editor.vue component)
                              // This access is reliable ASSUMING only 1 instance per page ... sorry
                              // https://docs.ckeditor.com/ckeditor4/latest/guide/dev_savedata.html
                              body.set('description', CKEDITOR.instances["editor-0"].getData());

                              var req = new XMLHttpRequest();
                              req.open('POST', '/home/new-post');
                              req.addEventListener('load', function() {

                                var resp = JSON.parse(req.responseText);

                                if (!resp.ok) {
                                  return resp.errors.forEach(function(e) {
                                    ImageUploader.displayError(e.message, errorContainer);
                                  });
                                }

                                location.assign(`${location.protocol}//${location.host}/posts/${resp.postId}`);
                              });

                              // Network error
                              req.addEventListener('error', function() {
                                ImageUploader.displayError(e.message, "We couldn't create your post due to an issue with the network. Check your internet connection and if that's all good, try back later. Sorry!");
                              });

                              req.send(body);
                            });


                            // TODO Add loading current images to init routine e.g. on edit
                            // Add images via template; loop over, add to uploadList, poop in your pants
                        }

                        function handleFileInput(e) {

                            var formElement = document.querySelector("form");
                            var formData = new FormData(formElement);
                            var selDiv = document.querySelector(".selected-files");
                            var uploadErrContainer = document.querySelector(".upload-errors-container");

                            // Reset error display
                            while (uploadErrContainer.firstChild) {
                              uploadErrContainer.removeChild(uploadErrContainer.firstChild)
                            }

                            // TODO Sensible way to handle this case? Error messaging?
                            if(!e.target.files || !window.FileReader) {
                              return;
                            }

                            // Should never be hit, with the input being disabled in the loop below; totally defensive
                            if (ImageUploader.filesList.length === 3) {
                              return ImageUploader.displayError("You've already uploaded max allowed images", uploadErrContainer);
                            }

                            // Validate newly uploaded file(s)
                            // If a file doesn't end up in ImageUploader.filesList, it won't be sent to the server
                            var files = e.target.files;
                            var filesArr = Array.prototype.slice.call(files); // TODO Array.from?

                            filesArr.forEach(function(f, index) {
                                var f = files[index];

                                if (f.type.match(/image\/(jpeg|png)/) === null) {
                                    return ImageUploader.displayError(`We can't process images in ${f.name}'s format. Retry uploading with a jpg or png image. Sorry!`, uploadErrContainer);
                                }

                                if (f.size > 1048576) {
                                  return ImageUploader.displayError(`${f.name} is too big; can't exceed 1MB`, uploadErrContainer);
                                }

                                // Store each newly uploaded file because each upload attempt i.e. drag once, then drag another,
                                // overwrites the input's file list
                                // Disable the uploader if limit has been reached
                                if (ImageUploader.filesList.push(f) === 3) {
                                  var enabledMsg = document.querySelector(".enabled-upload");
                                  var disabledMsg = document.querySelector(".disabled-upload");
                                  var dropbox = document.querySelector(".dropbox");
                                  var input = document.querySelector('#images');

                                  images.setAttribute("disabled", "disabled");
                                  enabledMsg.setAttribute("hidden", "hidden");
                                  disabledMsg.removeAttribute("hidden");
                                  dropbox.style.backgroundColor = "lightgray";
                                }

                                // User's attempting to upload >3 images at once
                                if (ImageUploader.filesList.length > 3) {
                                  return ImageUploader.displayError(`Upload for ${f.name} failed; you've already uploaded 3 images`, uploadErrContainer);
                                }

                                // Display thumbnail of successfully-uploaded image
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    var html = "<img src=\"" + e.target.result + "\">";
                                    selDiv.innerHTML += html;
                                }
                                reader.readAsDataURL(f);
                            });
                        }

                        function deleteUpload(e) {

                        }
                        // TODO Handle Deleting images and loading existing ones into the uploader
                    </script>
                </div>
                <div class="form-group">
                    <label>Post to Local Town</label>
                    <div class="input-with-icon">
                        <select class="select-post-town" name="town" data-width="100%">
                          {% for town in data.towns %}
                            {% if data.post.town === town.id %}
                              <option value="{{town.id}}" selected="selected">{{town.name}}</option>
                            {% else %}
                              <option value="{{town.id}}" >{{town.name}}</option>
                            {% endif %}
                          {% endfor %}
                        </select>
                        <span class="iconcenter">
                            {% include '../icons/map_pin.html' %}
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nearest Crossroads</label>
                    <div class="input-with-icon">
                        <input name="location" value="{{data.post.location}}" class="input-with-icon" type="search" />
                        <span class="iconcenter">
                            {% include '../icons/map_compass.html' %}
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <fc-editor name="description" value="{{data.post.description}}"></fc-editor>
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <select class="select-new-post-tags" name="tags" multiple="multiple" data-width="100%">
                      {% for tag in data.tags %}
                        {% if data.post.tags.includes(tag.id) %}
                          <option value="{{tag.id}}" selected="selected">{{tag.name}}</option>
                        {% else %}
                          <option value="{{tag.id}}">{{tag.name}}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                </div>
                <div class="form-group text-center terms-conditions">
                    <input type="checkbox" name="acceptedTerms" value="1" required /> <span class="button-palette-group-title">I AGREE TO THE </span> <a href="/"> TERMS AND CONDITIONS</a> {# TODO: update the link to terms #}
                </div>
                <div class="form-group text-center">
                    <button type="submit" role="submit" class="btn-default btn-wide">Post Item</button>
                </div>
            </form>
        </div>
        <hr class="section-divider" />
    </div>
    {% include '../partials/in_body_banner_row.html'%}

{% endblock %}
